# Codegen vs Proc-Macro: E0223 Comparison

## The Problem: E0223 in Procedural Macros

When using procedural macros, we hit E0223 (ambiguous associated type) errors:

```rust
// In lifeguard-derive/src/macros/life_model.rs
#[derive(LifeModel)]
struct User { ... }

// Generated code tries to do:
impl LifeModelTrait for Entity {
    type Column = Column;  // ❌ E0223: Column not resolved during nested expansion
}
```

**Root Cause:** `DeriveEntity` expands in a nested phase, and `Column` isn't fully resolved yet.

## The Solution: Codegen

With codegen, we generate complete code in one file:

```rust
// Generated by lifeguard-codegen
pub enum Column { ... }

impl LifeModelTrait for User {
    type Model = UserModel;
    type Column = Column;  // ✅ Works! Column is already defined
}
```

**Why It Works:**
1. All code generated in one pass
2. No nested macro expansion
3. Normal Rust compilation applies
4. Full type resolution

## Side-by-Side Comparison

### Procedural Macro Approach

```rust
// User writes:
#[derive(LifeModel)]
struct User { id: i32, email: String }

// Macro expansion phases:
// Phase 1: LifeModel generates Column enum
// Phase 2: LifeModel generates Entity with #[derive(DeriveEntity)]
// Phase 3: DeriveEntity expands (nested) - tries to reference Column
// ❌ E0223: Column not resolved in nested expansion
```

**Result:** ❌ E0223 error, tests fail

### Codegen Approach

```rust
// User runs:
lifeguard-codegen generate --input entities.toml --output src/entities

// Generated file (src/entities/user.rs):
pub enum Column { ... }           // ✅ Defined first
pub struct User { ... }
impl LifeModelTrait for User {
    type Column = Column;          // ✅ References already-defined Column
}

// Normal compilation:
// ✅ All types resolved
// ✅ No E0223
```

**Result:** ✅ Compiles successfully

## Test Results

### Proc-Macro Tests
```bash
$ cd lifeguard-derive && cargo test
error[E0223]: ambiguous associated type
  --> tests/test_minimal.rs:11:10
   |
11 | #[derive(LifeModel)]
   |          ^^^^^^^^^
```

**Status:** ❌ 5 tests fail with E0223

### Codegen Tests
```bash
$ cd lifeguard-codegen && cargo test
test test_generated_code_compiles ... ok

test result: ok. 1 passed; 0 failed
```

**Status:** ✅ All tests pass

## When to Use Each

### Use Procedural Macros For:
- ✅ Simple derives (FromRow, Debug, Clone)
- ✅ Quick prototyping
- ✅ Automatic integration (no manual steps)
- ✅ Small projects

### Use Codegen For:
- ✅ Complex entity generation
- ✅ Avoiding E0223 and similar issues
- ✅ Production code
- ✅ When you need inspectable generated code
- ✅ Better error messages
- ✅ Full type resolution

## Migration Path

1. **Start with Codegen** for new entities
2. **Keep Proc-Macros** for simple derives
3. **Gradually migrate** complex cases to codegen
4. **Document** which approach to use when

## Conclusion

Codegen solves the E0223 problem by generating complete, compilable code before the Rust compiler sees it. This avoids all macro expansion ordering issues and provides a more robust solution for complex entity generation.
