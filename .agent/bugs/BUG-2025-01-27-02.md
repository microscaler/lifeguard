# BUG-2025-01-27-02: build_where_condition uses wrong table reference

## Summary

The `build_where_condition` function incorrectly uses `rel_def.to_tbl` when building WHERE clauses, but the foreign key column (`from_col`) exists in `rel_def.from_tbl`. This causes SQL errors when querying related entities, especially for BelongsTo relationships.

## Discovery

**Date**: 2025-01-27  
**Source**: Cursor verification  
**Severity**: `high`  
**Status**: `fixed`

## Location

- **File**: `src/relation/def.rs`
- **Lines**: 286-292 (before fix)

## Description

When calling `user.find_related::<Post>()` for a BelongsTo relationship where Post has a `user_id` foreign key:

1. The `Related<Post>` trait returns a `RelationDef` where:
   - `from_tbl` = `posts` (where the foreign key `user_id` exists)
   - `to_tbl` = `users` (the target table)
   - `from_col` = `user_id` (the foreign key in posts table)
   - `to_col` = `id` (the primary key in users table)

2. The bug: `build_where_condition` was using `rel_def.to_tbl` (users) instead of `rel_def.from_tbl` (posts) when building the WHERE clause.

3. Result: The function generated `users.user_id = <pk>` instead of `posts.user_id = <pk>`, causing SQL errors because `user_id` doesn't exist in the users table.

## Root Cause

In `build_where_condition`, line 287 was:
```rust
let to_tbl_str = format!("{:?}", rel_def.to_tbl);
```

And line 292 was:
```rust
let col_expr = format!("{}.{}", to_tbl_str, fk_col_str);
```

The foreign key column (`from_col`) exists in the `from_tbl`, not the `to_tbl`, so the code should use `rel_def.from_tbl`.

## Fix

Changed lines 287-292 to use `rel_def.from_tbl` instead of `rel_def.to_tbl`:

```rust
// The foreign key column exists in from_tbl, not to_tbl
let from_tbl_str = format!("{:?}", rel_def.from_tbl);
let col_expr = format!("{}.{}", from_tbl_str, fk_col_str);
```

## Impact

- **Affected Functionality**: `find_related()` method for all relationship types (HasMany, HasOne, BelongsTo)
- **Affected Relationships**: All relationships, but most noticeable for BelongsTo relationships
- **SQL Errors**: Runtime SQL errors when querying related entities
- **User Impact**: Users cannot query related entities using `find_related()`

## Testing

Added integration test `test_build_where_condition_uses_from_tbl()` in `tests/integration/related_trait.rs` that:
1. Creates a User and Post with BelongsTo relationship
2. Calls `user.find_related::<Post>()`
3. Verifies the query succeeds (would fail with the bug)
4. Verifies the correct results are returned

## Related Files

- `src/relation/def.rs` - Fixed function
- `src/relation.rs` - Uses `build_where_condition` in `find_related()` implementation
- `tests/integration/related_trait.rs` - Added test for the fix

## Verification

- [x] Bug identified and root cause analyzed
- [x] Fix implemented
- [x] Test added to verify fix
- [ ] Tests run and passing (pending)
- [ ] Integration tests verify fix works in real scenarios
