# BUG-2026-01-20-04: select_as Integration Uses Wrong Method to Get Column Definition

**Date:** 2026-01-20  
**Status:** âœ… FIXED  
**Priority:** High  
**Severity:** Silent failure - select_as expressions never used

## Summary

The `select_as` integration in `SelectQuery::new()` was calling `ColumnTrait::def(*col)` to check for custom SELECT expressions, but this method uses the blanket impl's default which returns `ColumnDefinition::default()` where `select_as` is always `None`. The macro generates `Column::column_def()` as an inherent method (not trait method) due to blanket impl conflicts. Since `has_select_as` will always be `false`, the code always falls back to `SELECT *` and never uses `select_as` expressions.

## Discovery

**Date:** 2026-01-20  
**Source:** Code review / User report  
**Severity:** `high`  
**Status:** `fixed`

## Location

- **File:** `src/query/select.rs`
- **Lines:** 112-127 (before fix)

## Description

The `select_as` attribute allows users to specify custom SQL expressions for SELECT queries, e.g.:
```rust
#[select_as = "CONCAT(first_name, ' ', last_name) AS full_name"]
pub full_name: String,
```

When building SELECT queries, the code checks if any column has a `select_as` expression. If so, it builds individual column selections instead of using `SELECT *`.

**The Bug:** The code was calling `ColumnTrait::def(*col)` to get the column definition:
```rust
let has_select_as = columns.iter().any(|col| {
    ColumnTrait::def(*col).select_as.is_some()
});
```

However, `ColumnTrait::def()` has a blanket implementation that returns `ColumnDefinition::default()`, which always has `select_as = None`. The macro generates `column_def()` as an inherent method (not a trait method) to work around blanket impl conflicts. This means:
1. `ColumnTrait::def(*col)` always returns `ColumnDefinition::default()` with `select_as = None`
2. `has_select_as` is always `false`
3. The code always uses `SELECT *` and never uses `select_as` expressions

## Root Cause

The macro generates `column_def()` as an inherent method on the Column enum to avoid conflicts with the blanket impl `impl<T: IntoColumnRef> ColumnTrait for T {}`. However, inherent methods cannot be called on associated types in generic code without a trait bound.

## Fix

1. **Created `ColumnDefHelper` trait** (`src/query/column/column_trait.rs`):
   - Provides a way to call `column_def()` in generic code
   - The macro implements this trait for each Column enum

2. **Updated macro** (`lifeguard-derive/src/macros/life_model.rs`):
   - Added `impl ColumnDefHelper for Column` to make `column_def()` accessible generically

3. **Fixed `SelectQuery::new()`** (`src/query/select.rs`):
   - Changed from `ColumnTrait::def(*col)` to `<E::Column as ColumnDefHelper>::column_def(*col)`
   - Added trait bound `E::Column: ColumnDefHelper` to the impl block

**Key Changes:**
```rust
// Before (broken):
let has_select_as = columns.iter().any(|col| {
    ColumnTrait::def(*col).select_as.is_some()
});

// After (fixed):
let has_select_as = columns.iter().any(|col| {
    <E::Column as ColumnDefHelper>::column_def(*col).select_as.is_some()
});
```

## Testing

Added comprehensive tests in `src/query/select.rs`:

1. **`test_select_as_uses_custom_expression()`** - Verifies that when a column has `select_as`, the custom expression is used in the SQL query instead of `SELECT *`

2. **`test_select_as_detection_works()`** - Verifies that `has_select_as` correctly detects columns with `select_as` expressions

3. **`test_select_as_without_custom_expression_uses_asterisk()`** - Verifies that when no columns have `select_as`, the query uses `SELECT *` for efficiency

All tests pass, confirming the fix works correctly.

## Impact

- **Fixes silent failure:** `select_as` expressions are now correctly used in SELECT queries
- **No breaking changes:** Existing code continues to work, but now `select_as` actually functions as intended
- **Improves functionality:** Users can now use custom SELECT expressions as documented

## Related Files

- `src/query/select.rs` - Fixed to use `ColumnDefHelper::column_def()`
- `src/query/column/column_trait.rs` - Added `ColumnDefHelper` trait
- `lifeguard-derive/src/macros/life_model.rs` - Added `impl ColumnDefHelper for Column`

## Verification

- [x] Bug identified and root cause analyzed
- [x] Fix implemented (created `ColumnDefHelper` trait and updated code)
- [x] Tests added to verify fix
- [x] Tests run and passing
- [x] Integration tests verify fix works in real scenarios
