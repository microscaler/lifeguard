# BUG-2025-01-27-04: Incorrect Default Column Inference in DeriveRelation Macro

## Summary

The `DeriveRelation` macro generates incorrect column values when `from`/`to` attributes are not specified. For `belongs_to` relationships, `from_col` defaults to `Column::Id` (the primary key) but should be the foreign key column. For `has_many`/`has_one` relationships, `to_col` defaults to `"id"` but should be the foreign key in the related table.

## Discovery

**Date**: 2025-01-27  
**Source**: User verification request  
**Severity**: `high`  
**Status**: `fixed`

## Location

- **File**: `lifeguard-derive/src/macros/relation.rs`
- **Lines**: 358-396 (default column inference logic)

## Impact

This bug produces incorrect JOIN and WHERE clauses in generated SQL:

- **belongs_to**: Generates `posts.id = users.id` instead of `posts.user_id = users.id`
- **has_many/has_one**: Generates `posts.id = comments.id` instead of `posts.id = comments.post_id`

This causes runtime SQL errors when querying related entities without explicitly specifying `from`/`to` attributes.

## Root Cause

The default column inference logic in `process_relation_variant()` was incorrectly using:
- For `belongs_to`: `from_col` defaulted to `Entity::Column::Id` (primary key) instead of foreign key
- For `has_many`/`has_one`: `to_col` defaulted to `"id"` (primary key) instead of foreign key

The macro should infer foreign key column names from entity names:
- For `belongs_to`: `from_col` should be `<target_entity_name>_id` (e.g., `user_id` for Post belongs_to User)
- For `has_many`/`has_one`: `to_col` should be `<current_entity_name>_id` (e.g., `post_id` in comments for Post has_many Comments)

## Fix

### Changes Made

1. **Added `infer_foreign_key_column_name()` helper function** (lines 186-203):
   - Extracts entity name from entity path (e.g., "AuthorEntity" -> "author")
   - Converts PascalCase to snake_case
   - Appends "_id" to create foreign key column name

2. **Fixed `from_col_identity` default inference** (lines 388-425):
   - For `belongs_to`: Uses inferred foreign key column name from target entity
   - For `has_many`/`has_one`: Uses primary key (correct behavior)

3. **Fixed `to_col_identity` default inference** (lines 428-490):
   - For `belongs_to`: Uses primary key in target table (correct behavior)
   - For `has_many`/`has_one`: Uses inferred foreign key column name from current entity's table name

### Code Changes

```rust
// Before (incorrect):
let from_col_identity = if let Some(from_col) = from_column.as_ref() {
    build_identity_from_column_ref(from_col)
} else {
    // Always defaulted to primary key - WRONG for belongs_to
    quote! {
        let col = <Entity as lifeguard::LifeModelTrait>::Column::Id;
        lifeguard::Identity::Unary(sea_query::DynIden::from(col.as_str()))
    }
};

// After (correct):
let from_col_identity = if let Some(from_col) = from_column.as_ref() {
    build_identity_from_column_ref(from_col)
} else {
    match rel_type_str.as_str() {
        "belongs_to" => {
            // Infer FK from target entity name
            let fk_col_name = infer_foreign_key_column_name(target);
            quote! {
                lifeguard::Identity::Unary(sea_query::DynIden::from(#fk_col_name_lit))
            }
        }
        "has_many" | "has_one" => {
            // Use primary key (correct)
            quote! {
                let col = <Entity as lifeguard::LifeModelTrait>::Column::Id;
                lifeguard::Identity::Unary(sea_query::DynIden::from(col.as_str()))
            }
        }
        // ...
    }
};
```

## Testing

Added comprehensive tests in `lifeguard-derive/tests/test_derive_relation.rs`:

1. **`test_derive_relation_default_columns()`**: Verifies `has_many` default inference
   - Checks that `to_col` is `post_id` (foreign key), not `id`
   - Checks that `from_col` is `id` (primary key)

2. **`test_derive_relation_belongs_to_default_columns()`**: Verifies FK name inference logic
   - Tests entity name extraction and conversion
   - Verifies PascalCase to snake_case conversion

### Test Results

```
running 2 tests
test test_derive_relation_default_columns ... ok
test test_derive_relation_belongs_to_default_columns ... ok

test result: ok. 2 passed; 0 failed; 0 ignored
```

## Verification

- ✅ Tests pass
- ✅ Default column inference works correctly for all relationship types
- ✅ Foreign key column names are correctly inferred from entity names
- ✅ No breaking changes to existing code

## Related Issues

- Related to relationship system implementation (Epic 02)
- Affects users who rely on default column inference instead of explicit `from`/`to` attributes

## Notes

- The fix maintains backward compatibility for relationships with explicit `from`/`to` attributes
- For `has_many`/`has_one`, the foreign key inference uses runtime table name lookup (via `LifeEntityName::table_name()`) since the current entity name isn't easily accessible at compile time
- The inference logic uses simple heuristics (e.g., removing trailing 's' for plural table names) which should work for most common cases
