# BUG-2026-01-18-02: DeriveTryIntoModel Macro Incorrect Error Handling for Custom Error Types with Convert Attribute

**Date:** 2026-01-18  
**Status:** ✅ FIXED  
**Priority:** High  
**Severity:** Compilation error / API inconsistency

## Summary

When a custom error type is specified via `#[lifeguard(error = "CustomError")]` and a field uses `#[lifeguard(convert = "...")]`, the generated code incorrectly wraps conversion errors in `lifeguard::LifeError::Other(...)` but the function's return type is the custom error. The `?` operator then requires `CustomError: From<lifeguard::LifeError>`, which is an undocumented requirement that causes confusing compilation failures.

## Discovery

**Date:** 2026-01-18  
**Source:** Code review / User report  
**Severity:** `high`  
**Status:** `fixed`

## Location

- **File:** `lifeguard-derive/src/macros/try_into_model.rs`
- **Lines:** 127-135 (original bug), 148-160 (error type extraction)

## Description

The `DeriveTryIntoModel` macro generates code that wraps conversion function errors in `lifeguard::LifeError::Other(...)` regardless of the specified error type. When a custom error type is used, this causes a type mismatch:

1. User specifies `#[lifeguard(error = "CustomError")]`
2. User uses `#[lifeguard(convert = "convert_fn")]` on a field
3. Macro generates: `convert_fn(self.field).map_err(|e| lifeguard::LifeError::Other(...))?`
4. Function signature expects: `Result<Model, CustomError>`
5. Compiler error: `CustomError` needs to implement `From<lifeguard::LifeError>`

This is confusing because:
- The requirement is undocumented
- Users expect the conversion function's error type to be used directly
- The error message suggests implementing `From<LifeError>` when it should be `From<ConversionError>`

## Root Cause

The macro always wrapped conversion errors in `LifeError::Other`, regardless of the specified error type. The code did not check whether the error type was `LifeError` (default) or a custom error type.

## Fix

Modified the macro to:
1. Check if the error type is `LifeError` (default) by comparing string representation
2. If `LifeError`: wrap conversion errors in `LifeError::Other(...)` (preserves existing behavior)
3. If custom error type: use `?` directly on the conversion function's error, which requires `CustomError: From<ConversionError>` instead of `CustomError: From<LifeError>`

**Code changes:**
- Added error type detection logic to check if it's `LifeError`
- Conditional code generation: wrap in `LifeError::Other` for default, use `?` directly for custom types
- This ensures the correct `From` trait requirement is documented by the compiler error

## Testing

### Negative Test (Compile Error)
- **File:** `lifeguard-derive/tests/ui/compile_error_try_into_model_custom_error_convert.rs`
- **Test:** Verifies that when `CustomError` doesn't implement `From<ParseIntError>`, compilation fails with the correct error message
- **Expected:** Error message requires `From<ParseIntError>` (conversion function's error type), not `From<LifeError>`

### Positive Tests
- **File:** `lifeguard-derive/tests/test_try_into_model.rs`
- **Test 1:** `test_derive_try_into_model_custom_error_type_with_convert`
  - Verifies custom error type works when conversion function returns the custom error type
- **Test 2:** `test_derive_try_into_model_custom_error_type_with_from_trait`
  - Verifies custom error type works when conversion function returns a different error type but `From` trait is implemented
- **Test 3:** `test_derive_try_into_model_custom_error_type_with_from_trait_error`
  - Verifies conversion errors are properly propagated through `From` trait

All tests pass ✅

## Impact

- **Before:** Users specifying custom error types with `convert` attribute got confusing error messages requiring `From<LifeError>`
- **After:** Users get correct error messages requiring `From<ConversionError>`, making it clear what trait implementation is needed
- **Breaking Changes:** None - this is a bug fix that improves error messages

## Related Files

- `lifeguard-derive/src/macros/try_into_model.rs` - Macro implementation
- `lifeguard-derive/tests/test_try_into_model.rs` - Positive test cases
- `lifeguard-derive/tests/ui/compile_error_try_into_model_custom_error_convert.rs` - Negative test case
- `lifeguard-derive/tests/ui/compile_error_try_into_model_custom_error_convert.stderr` - Expected error output

## Verification

- [x] Bug identified and root cause analyzed
- [x] Fix implemented
- [x] Test added to verify fix (negative case)
- [x] Tests added to verify positive scenarios
- [x] Tests run and passing
- [x] Integration tests verify fix works in real scenarios
