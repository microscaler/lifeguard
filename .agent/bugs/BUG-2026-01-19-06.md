# BUG-2026-01-19-06: `#[skip]` and `#[primary_key]` Attributes Can Be Used Together, Causing Silent Primary Key Tracking Failure

**Date:** 2026-01-19  
**Status:** ✅ FIXED  
**Priority:** High  
**Severity:** Silent data corruption / Runtime errors

## Summary

The `#[skip]` (or `#[ignore]`) attribute handling doesn't validate against simultaneous use with `#[primary_key]`. When a field has both attributes, the `continue` statement causes the primary key tracking code to be skipped entirely. This silently produces an entity with an incomplete or empty `PrimaryKey` enum, leading to incorrect INSERT/UPDATE operations, potential constraint violations, or missing auto-increment handling—without any compile-time or runtime error to alert the user.

## Discovery

**Date:** 2026-01-19  
**Source:** Code review and user report  
**Severity:** `high`  
**Status:** `fixed`

## Location

- **File:** `lifeguard-derive/src/macros/life_model.rs`
- **Lines:** 108-134 (attribute extraction and ignored field handling)
- **File:** `lifeguard-derive/src/macros/life_record.rs`
- **Lines:** 109-144 (attribute extraction and ignored field handling)

## Description

### The Problem

When a field has both `#[skip]` (or `#[ignore]`) and `#[primary_key]` attributes:

1. **In `life_model.rs`:**
   - Line 109-112: Attributes are extracted, including `is_primary_key` and `is_ignored`
   - Line 116-134: If `is_ignored` is true, the code adds the field to the Model struct and then `continue`s
   - Line 154-173: Primary key tracking code is **after** the continue, so it's never executed
   - Result: Primary key is not tracked, `PrimaryKey` enum is incomplete or empty

2. **In `life_record.rs`:**
   - Line 110-113: Attributes are extracted
   - Line 117-144: If `is_ignored` is true, the code adds the field to the Record struct and then `continue`s
   - Line 152-157: Primary key tracking code is **after** the continue, so it's never executed
   - Result: Primary key is not tracked in Record operations

### Impact

- **Silent failure**: No compile-time or runtime error alerts the user
- **Incorrect INSERT operations**: Without primary key tracking, INSERT statements may fail or produce incorrect results
- **Incorrect UPDATE operations**: UPDATE statements may affect wrong rows or fail entirely
- **Missing auto-increment handling**: Auto-increment fields won't be properly handled
- **Constraint violations**: Database constraints may be violated without clear error messages
- **Data corruption risk**: Operations may succeed but produce incorrect data

### Example of Problematic Code

```rust
#[derive(LifeModel, LifeRecord)]
#[table_name = "users"]
pub struct User {
    #[primary_key]
    #[skip]  // ERROR: This silently breaks primary key tracking
    pub id: i32,
    pub name: String,
}
```

This code would compile successfully but:
- The `PrimaryKey` enum would be empty or incomplete
- INSERT/UPDATE operations would fail or behave incorrectly
- No error message would indicate the problem

## Root Cause

The validation check for conflicting attributes was missing. The code checked `is_ignored` and used `continue` to skip database column generation, but it did this **before** checking if the field was also a primary key. Since primary keys are essential for database operations, they cannot be skipped.

## Fix

### Changes Made

1. **Added validation in `life_model.rs`** (lines 114-122):
   - Check if both `is_primary_key` and `is_ignored` are true
   - If so, emit a compile-time error using `syn::Error::new_spanned`
   - Error message: "Field cannot have both `#[primary_key]` and `#[skip]` (or `#[ignore]`) attributes. Primary key fields must be included in database operations."

2. **Added validation in `life_record.rs`** (lines 115-123):
   - Same validation check as in `life_model.rs`
   - Ensures consistency across both macros

3. **Added UI tests**:
   - `compile_error_skip_primary_key.rs` - Tests `#[skip]` + `#[primary_key]` conflict
   - `compile_error_ignore_primary_key.rs` - Tests `#[ignore]` + `#[primary_key]` conflict
   - Both tests verify that compile errors are emitted with clear error messages

### Code Changes

**Before:**
```rust
let is_primary_key = col_attrs.is_primary_key;
let is_auto_increment = col_attrs.is_auto_increment;
let is_ignored = col_attrs.is_ignored;

// Skip ignored fields...
if is_ignored {
    // ... add to struct ...
    continue;  // Primary key tracking never happens
}
// Primary key tracking code here (never reached for ignored fields)
```

**After:**
```rust
let is_primary_key = col_attrs.is_primary_key;
let is_auto_increment = col_attrs.is_auto_increment;
let is_ignored = col_attrs.is_ignored;

// Validate: primary key fields cannot be skipped/ignored
if is_primary_key && is_ignored {
    return syn::Error::new_spanned(
        field_name,
        "Field cannot have both `#[primary_key]` and `#[skip]` (or `#[ignore]`) attributes. Primary key fields must be included in database operations.",
    )
    .to_compile_error()
    .into();
}

// Skip ignored fields...
if is_ignored {
    // ... add to struct ...
    continue;
}
// Primary key tracking code here
```

## Testing

### Positive Cases
- Fields with only `#[skip]` work correctly (no primary key)
- Fields with only `#[primary_key]` work correctly (not skipped)
- Fields with `#[skip]` and other attributes (but not `#[primary_key]`) work correctly

### Negative Cases
- **Test**: `compile_error_skip_primary_key`
  - Verifies that `#[skip]` + `#[primary_key]` emits compile error
  - Error message is clear and points to the problematic field

- **Test**: `compile_error_ignore_primary_key`
  - Verifies that `#[ignore]` + `#[primary_key]` emits compile error
  - Error message is clear and points to the problematic field

## Impact

- **Before**: Silent failure - code compiles but produces incorrect behavior at runtime
- **After**: Compile-time error with clear message prevents the issue entirely
- **Breaking Changes**: None - this is a bug fix that prevents invalid code from compiling

## Related Files

- `lifeguard-derive/src/macros/life_model.rs` - Main fix location
- `lifeguard-derive/src/macros/life_record.rs` - Main fix location
- `lifeguard-derive/tests/ui/compile_error_skip_primary_key.rs` - Test case
- `lifeguard-derive/tests/ui/compile_error_ignore_primary_key.rs` - Test case
- `lifeguard-derive/tests/ui.rs` - Test registration

## Verification

- [x] Bug identified and root cause analyzed
- [x] Fix implemented in both `life_model.rs` and `life_record.rs`
- [x] UI tests added to verify compile errors are emitted
- [x] Tests verify error messages are clear and point to correct field
- [x] No linting errors introduced
- [x] Bug tracker entry created
