# BUG-2024-12-19-03: DerivePartialModel Macro Inconsistent FromRow Implementation

**Date:** 2024-12-19  
**Status:** ✅ **FIXED**  
**Priority:** High  
**Severity:** Bug - Inconsistency with codegen and LifeModel macro

## Summary

The `DerivePartialModel` macro generated `FromRow` implementations using `row.get(column_name)?`, while both the `lifeguard-codegen` tool and the `LifeModel` macro use `row.try_get::<&str, Type>(column_name)?`. This inconsistency could lead to different error handling behavior and type inference issues.

## Discovery

**Date:** 2024-12-19  
**Source:** Code review / consistency check  
**Severity:** `high`  
**Status:** `fixed`

## Location

- **File:** `lifeguard-derive/src/macros/partial_model.rs:132-139`

## Description

**Before (Inconsistent Code):**
```rust
// For unsigned types:
let val: #signed_type = row.get(#column_name_str)?;

// For regular types:
row.get(#column_name_str)?
```

**Codegen (Correct Pattern):**
```rust
// For unsigned types:
let val: i16 = row.try_get::<&str, i16>("id")?;

// For regular types:
row.try_get::<&str, i32>("id")?
```

**LifeModel Macro (Correct Pattern):**
```rust
// For unsigned types:
let val: #signed_type = row.try_get::<&str, #signed_type>(#column_name_str)?;

// For regular types:
row.try_get::<&str, #field_type>(#column_name_str)?
```

**Problem:**
- `row.get()` and `row.try_get()` have different signatures and error handling behavior
- `row.get()` relies on type inference, while `row.try_get::<&str, Type>()` is explicit
- Maintenance confusion: developers might expect consistent patterns across all code generation paths

## Root Cause

The `DerivePartialModel` macro was implemented before the codegen tool, and used `row.get()` which is a simpler API. However, when the codegen tool was created, it used `row.try_get::<&str, Type>()` to match the `LifeModel` macro's pattern. The macro was never updated to match.

## Fix

**After (Fixed Code):**
```rust
// For unsigned types:
let val: #signed_type = row.try_get::<&str, #signed_type>(#column_name_str)?;

// For regular types:
row.try_get::<&str, #field_type>(#column_name_str)?
```

**Changes:**
1. ✅ Updated unsigned type handling to use `row.try_get::<&str, #signed_type>()`
2. ✅ Updated regular type handling to use `row.try_get::<&str, #field_type>()`
3. ✅ Now consistent with both `lifeguard-codegen` and `LifeModel` macro implementations

## Testing

**Existing Tests:**
- `test_derive_partial_model.rs` - Tests macro-generated partial models
- `test_derive_partial_model_codegen.rs` - Tests codegen-generated partial models

**Verification:**
- Both test files should continue to pass after this fix
- Generated code now matches between macro and codegen approaches

## Impact

- **Before Fix:** Inconsistent API usage between macro and codegen-generated code
- **After Fix:** 
  - All code generation paths use the same `row.try_get::<&str, Type>()` pattern
  - Consistent error handling and type inference across all partial model implementations
  - Easier maintenance and debugging

## Related Files

- `lifeguard-derive/src/macros/partial_model.rs:131-141` - Fixed macro implementation
- `lifeguard-codegen/src/main.rs:171-175` - Reference: codegen implementation (already correct)
- `lifeguard-derive/src/macros/life_model.rs:834-840` - Reference: LifeModel macro implementation (already correct)

## Verification

- [x] Bug identified and root cause analyzed
- [x] Fix implemented
- [x] Tests continue to pass
- [x] Code generation now consistent
