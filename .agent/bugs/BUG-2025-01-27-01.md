# BUG-2025-01-27-01: Use of moved variable `record_for_hooks` in `returning_extractors`

**Date**: 2025-01-27  
**Source**: Cursor verification  
**Status**: `fixed`  
**Severity**: `critical`  
**Location**: `lifeguard-derive/src/macros/life_record.rs:265` (was 264)

## Impact

Compilation error for entities with `#[auto_increment]` primary keys in the `insert()` method. The bug prevents any entity with auto-increment primary keys from compiling.

## Description

The `returning_extractors` code checks `record_for_hooks.get()` but this variable has already been moved to `updated_record` earlier in the generated `insert()` method. 

**Sequence of events:**
1. At line 614, `record_for_hooks` is moved via `let mut updated_record = record_for_hooks;`
2. At line 627, `#(#returning_extractors)*` expands code that tries to use `record_for_hooks.get()`
3. This causes a compilation error because `record_for_hooks` has been moved and is no longer available

## Root Cause

The code generated in `returning_extractors` (line 263-271) used `record_for_hooks.get()` at line 265, but by the time this code is expanded at line 627, `record_for_hooks` has been moved to `updated_record` at line 614.

The issue occurs because:
- The `returning_extractors` code is generated during macro expansion (lines 262-270)
- The generated code references `record_for_hooks` which exists at generation time
- However, when the code is actually expanded at line 627, `record_for_hooks` has already been moved to `updated_record` at line 614
- Rust's move semantics prevent using a moved variable

## Fix

Changed line 265 to use `updated_record.get()` instead of `record_for_hooks.get()`, since `updated_record` is the variable that exists at expansion time. Added clarifying comment explaining why `updated_record` is used instead of `record_for_hooks`.

**Code change:**
```rust
// Before (line 264):
if record_for_hooks.get(<#entity_name as lifeguard::LifeModelTrait>::Column::#column_variant).is_none() {

// After (line 265):
if updated_record.get(<#entity_name as lifeguard::LifeModelTrait>::Column::#column_variant).is_none() {
```

**Additional changes:**
- Updated comment at line 261-262 to explain why `updated_record` is used
- The fix ensures the code references the correct variable that exists at expansion time

## Verification

- [x] Code compiles without errors (linter check passed)
- [ ] Tests pass for entities with auto-increment primary keys (needs runtime verification)
- [ ] Integration tests verify RETURNING clause works correctly (needs runtime verification)

## Related Files

- `lifeguard-derive/src/macros/life_record.rs` - Main file containing the bug and fix

## Notes

This bug was discovered via Cursor's "Verify this issue exists and fix it" workflow. The fix is straightforward but critical - without it, any entity with `#[auto_increment]` primary keys would fail to compile.
